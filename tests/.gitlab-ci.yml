stages:
  - build
  - deploy

variables:
  KUBECONFIG: ENV UVICORN_HOST=0.0.0.0 UVICORN_PORT=8000

build:
  stage: build
  script:
    - docker build -t fastapi .
    - docker save fastapi | gzip > fastapi.tar.gz
  artifacts:
    paths:
    - fastapi.tar.gz

deploy:
  stage: deploy
  script:
    - echo "$KUBECONFIG" > kubeconfig.yaml
    - kubectl apply -f KubernetesManifest.yml